---
import MetricsGrid from './MetricsGrid.astro';
import SuggestionBox from './SuggestionBox.astro';
import ChartsGrid from './ChartsGrid.astro';

interface Props {
    id?: string;
}

const { id = "results" } = Astro.props;
---

<div id={id} class="results hidden px-6 md:px-8 pb-8">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-1 h-8 bg-[#D4A843] rounded-full"></div>
        <h2 class="font-['DM_Serif_Display',serif] text-2xl md:text-3xl font-normal text-[#E8F0E4]">Climate Analysis</h2>
    </div>
    <MetricsGrid />
    <ChartsGrid />
    <SuggestionBox />
</div>

<script>
    const resultsEl = document.getElementById('results');

    interface AnalysisData {
        metrics: {
            avg_temp: number;
            max_temp: number;
            extreme_heat_days: number;
            avg_radiation: number;
            optimal_solar_days: number;
            avg_humidity: number;
        };
        suggestion: string;
        charts: {
            temperature: string;
            solar: string;
        };
    }

    window.addEventListener('show-results', ((e: CustomEvent<AnalysisData>) => {
        const data = e.detail;
        const m = data.metrics;
        const metricsEl = document.getElementById('metrics');
        
        if (metricsEl) {
            metricsEl.innerHTML = `
                <div class="metric-card">
                    <div class="label">üå°Ô∏è Avg. Temp</div>
                    <div class="value">${m.avg_temp}¬∞C</div>
                </div>
                <div class="metric-card">
                    <div class="label">üî• Max Temp</div>
                    <div class="value">${m.max_temp}¬∞C</div>
                </div>
                <div class="metric-card">
                    <div class="label">‚ö†Ô∏è Extreme Heat Days</div>
                    <div class="value">${m.extreme_heat_days}</div>
                </div>
                <div class="metric-card">
                    <div class="label">‚òÄÔ∏è Solar Radiation</div>
                    <div class="value">${m.avg_radiation}</div>
                    <div class="label text-xs">MJ/m¬≤</div>
                </div>
                <div class="metric-card">
                    <div class="label">üå§Ô∏è Optimal Solar Days</div>
                    <div class="value">${m.optimal_solar_days}</div>
                </div>
                <div class="metric-card">
                    <div class="label">üíß Avg. Humidity</div>
                    <div class="value">${m.avg_humidity}%</div>
                </div>
            `;
        }
        
        const suggestionEl = document.getElementById('suggestion');
        if (suggestionEl) suggestionEl.textContent = data.suggestion;
        
        const chartTemp = document.getElementById('chart-temp') as HTMLImageElement;
        const chartSolar = document.getElementById('chart-solar') as HTMLImageElement;
        
        if (chartTemp) chartTemp.src = `data:image/png;base64,${data.charts.temperature}`;
        if (chartSolar) chartSolar.src = `data:image/png;base64,${data.charts.solar}`;
        
        resultsEl?.classList.add('active');
        resultsEl?.classList.remove('hidden');
        resultsEl?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }) as EventListener);
</script>
