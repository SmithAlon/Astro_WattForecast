---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import EnergyForm from '../components/EnergyForm.astro';
import Alert from '../components/Alert.astro';
import Loading from '../components/Loading.astro';
import ResultsSection from '../components/ResultsSection.astro';
---

<Layout>
    <Header />
    
    <div class="p-10">
        <EnergyForm />
        <ResultsSection />
        <Alert />
        <Loading />
    </div>
</Layout>

<script>
    // ==========================================
    // CONFIGURATION
    // ==========================================
    const API_URL = 'http://localhost:5000';
    
    // ==========================================
    // DOM ELEMENTS
    // ==========================================
    const form = document.getElementById('form');
    const loadingEl = document.getElementById('loading');
    const resultsEl = document.getElementById('results');
    const alertEl = document.getElementById('alert');
    const btnExport = document.getElementById('btnExport');
    
    // Location elements
    const locationSearch = document.getElementById('location-search') as HTMLInputElement;
    const btnSearchLocation = document.getElementById('btnSearchLocation') as HTMLButtonElement;
    const locationResults = document.getElementById('location-results');
    const locationSelected = document.getElementById('location-selected');
    const locationName = document.getElementById('location-name');
    const locationCoords = document.getElementById('location-coords');
    const btnClearLocation = document.getElementById('btnClearLocation');
    const quickZones = document.querySelectorAll('.quick-zone');
    
    // Hidden fields
    const zonaInput = document.getElementById('zona') as HTMLInputElement;
    const latInput = document.getElementById('lat') as HTMLInputElement;
    const lonInput = document.getElementById('lon') as HTMLInputElement;
    const tzInput = document.getElementById('tz') as HTMLInputElement;
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    function showLoading(show: boolean) {
        if (show) {
            loadingEl?.classList.add('active');
            loadingEl?.classList.remove('hidden');
            resultsEl?.classList.remove('active');
            resultsEl?.classList.add('hidden');
        } else {
            loadingEl?.classList.remove('active');
            loadingEl?.classList.add('hidden');
        }
    }
    
    function showAlert(message: string, type = 'error') {
        if (alertEl) {
            alertEl.textContent = message;
            alertEl.className = `py-4 px-5 rounded-lg my-5 alert alert-${type} active`;
            setTimeout(() => {
                alertEl.classList.remove('active');
                alertEl.classList.add('hidden');
            }, 5000);
        }
    }
    
    // ==========================================
    // LOCATION SEARCH
    // ==========================================
    
    let searchTimeout: ReturnType<typeof setTimeout> | null = null;
    
    async function searchLocations(query: string) {
        if (!query || query.length < 2) {
            locationResults?.classList.remove('active');
            locationResults?.classList.add('hidden');
            return;
        }
        
        if (btnSearchLocation) {
            btnSearchLocation.disabled = true;
            btnSearchLocation.textContent = '‚è≥';
        }
        
        try {
            const response = await fetch(`${API_URL}/api/geocode?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.results && data.results.length > 0) {
                showLocationResults(data.results);
            } else {
                if (locationResults) {
                    locationResults.innerHTML = '<div class="location-item"><em>No results found</em></div>';
                    locationResults.classList.add('active');
                    locationResults.classList.remove('hidden');
                }
            }
        } catch (error) {
            console.error('Error searching locations:', error);
            showAlert('Error searching locations');
        } finally {
            if (btnSearchLocation) {
                btnSearchLocation.disabled = false;
                btnSearchLocation.textContent = 'üîç';
            }
        }
    }
    
    interface LocationResult {
        display: string;
        lat: number;
        lon: number;
        tz: string;
        name: string;
        admin1?: string;
        country: string;
    }
    
    function showLocationResults(results: LocationResult[]) {
        if (!locationResults) return;
        
        locationResults.innerHTML = results.map(r => `
            <div class="location-item" 
                 data-name="${r.display}" 
                 data-lat="${r.lat}" 
                 data-lon="${r.lon}"
                 data-tz="${r.tz}">
                <div class="name">${r.name}</div>
                <div class="detail">${r.admin1 ? r.admin1 + ', ' : ''}${r.country}</div>
            </div>
        `).join('');
        
        locationResults.classList.add('active');
        locationResults.classList.remove('hidden');
        
        locationResults.querySelectorAll('.location-item').forEach(item => {
            item.addEventListener('click', () => selectLocation(item as HTMLElement));
        });
    }
    
    function selectLocation(item: HTMLElement) {
        const name = item.dataset.name || '';
        const lat = parseFloat(item.dataset.lat || '0');
        const lon = parseFloat(item.dataset.lon || '0');
        const tz = item.dataset.tz || '';
        
        if (zonaInput) zonaInput.value = name;
        if (latInput) latInput.value = String(lat);
        if (lonInput) lonInput.value = String(lon);
        if (tzInput) tzInput.value = tz;
        
        if (locationName) locationName.textContent = name;
        if (locationCoords) locationCoords.textContent = `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
        if (locationSelected) {
            locationSelected.classList.add('active');
            locationSelected.classList.remove('hidden');
            locationSelected.style.display = 'flex';
        }
        
        locationResults?.classList.remove('active');
        locationResults?.classList.add('hidden');
        if (locationSearch) locationSearch.value = '';
    }
    
    function clearLocation() {
        if (zonaInput) zonaInput.value = '';
        if (latInput) latInput.value = '';
        if (lonInput) lonInput.value = '';
        if (tzInput) tzInput.value = '';
        if (locationSelected) {
            locationSelected.classList.remove('active');
            locationSelected.classList.add('hidden');
            locationSelected.style.display = 'none';
        }
        if (locationSearch) locationSearch.value = '';
    }
    
    // Event listeners for location search
    locationSearch?.addEventListener('input', (e) => {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchLocations((e.target as HTMLInputElement).value);
        }, 300);
    });
    
    locationSearch?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchLocations(locationSearch.value);
        }
    });
    
    btnSearchLocation?.addEventListener('click', () => {
        if (locationSearch) searchLocations(locationSearch.value);
    });
    
    btnClearLocation?.addEventListener('click', clearLocation);
    
    document.addEventListener('click', (e) => {
        if (!(e.target as HTMLElement).closest('.location-container')) {
            locationResults?.classList.remove('active');
            locationResults?.classList.add('hidden');
        }
    });
    
    // Quick zones
    quickZones.forEach(btn => {
        btn.addEventListener('click', () => {
            const element = btn as HTMLElement;
            const name = element.textContent || '';
            
            if (zonaInput) zonaInput.value = element.dataset.zona || '';
            if (latInput) latInput.value = element.dataset.lat || '';
            if (lonInput) lonInput.value = element.dataset.lon || '';
            if (tzInput) tzInput.value = element.dataset.tz || '';
            
            if (locationName) locationName.textContent = name;
            if (locationCoords) locationCoords.textContent = `Lat: ${element.dataset.lat}, Lon: ${element.dataset.lon}`;
            if (locationSelected) {
                locationSelected.classList.add('active');
                locationSelected.classList.remove('hidden');
                locationSelected.style.display = 'flex';
            }
            locationResults?.classList.remove('active');
            locationResults?.classList.add('hidden');
        });
    });
    
    // ==========================================
    // MAIN ANALYSIS
    // ==========================================
    
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const userTypeSelect = document.getElementById('user_type') as HTMLSelectElement;
        const daysInput = document.getElementById('days') as HTMLInputElement;
        
        const userType = userTypeSelect?.value;
        const zona = zonaInput?.value;
        const lat = latInput?.value ? parseFloat(latInput.value) : null;
        const lon = lonInput?.value ? parseFloat(lonInput.value) : null;
        const tz = tzInput?.value || null;
        const days = parseInt(daysInput?.value || '30');
        
        if (!zona) {
            showAlert('Please select or search for a location');
            return;
        }
        
        if (days < 7 || days > 365) {
            showAlert('Days must be between 7 and 365');
            return;
        }
        
        showLoading(true);
        
        try {
            const requestBody: Record<string, any> = {
                user_type: userType,
                zona: zona,
                days: days
            };
            
            if (lat !== null && lon !== null) {
                requestBody.lat = lat;
                requestBody.lon = lon;
                if (tz) requestBody.tz = tz;
            }
            
            const response = await fetch(`${API_URL}/api/analyze`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                showResults(data);
                showAlert('‚úÖ Analysis completed successfully', 'success');
            } else {
                throw new Error(data.error || 'Unknown error');
            }
            
        } catch (error: any) {
            console.error('Error:', error);
            showAlert(`‚ùå Error: ${error.message}`);
        } finally {
            showLoading(false);
        }
    });
    
    // ==========================================
    // SHOW RESULTS
    // ==========================================
    
    interface AnalysisData {
        metrics: {
            avg_temp: number;
            max_temp: number;
            extreme_heat_days: number;
            avg_radiation: number;
            optimal_solar_days: number;
            avg_humidity: number;
        };
        suggestion: string;
        charts: {
            temperature: string;
            solar: string;
        };
    }
    
    function showResults(data: AnalysisData) {
        const m = data.metrics;
        const metricsEl = document.getElementById('metrics');
        
        if (metricsEl) {
            metricsEl.innerHTML = `
                <div class="metric-card">
                    <div class="label">üå°Ô∏è Avg. Temp</div>
                    <div class="value">${m.avg_temp}¬∞C</div>
                </div>
                <div class="metric-card">
                    <div class="label">üî• Max Temp</div>
                    <div class="value">${m.max_temp}¬∞C</div>
                </div>
                <div class="metric-card">
                    <div class="label">‚ö†Ô∏è Extreme Heat Days</div>
                    <div class="value">${m.extreme_heat_days}</div>
                </div>
                <div class="metric-card">
                    <div class="label">‚òÄÔ∏è Solar Radiation</div>
                    <div class="value">${m.avg_radiation}</div>
                    <div class="label text-xs">MJ/m¬≤</div>
                </div>
                <div class="metric-card">
                    <div class="label">üå§Ô∏è Optimal Solar Days</div>
                    <div class="value">${m.optimal_solar_days}</div>
                </div>
                <div class="metric-card">
                    <div class="label">üíß Avg. Humidity</div>
                    <div class="value">${m.avg_humidity}%</div>
                </div>
            `;
        }
        
        const suggestionEl = document.getElementById('suggestion');
        if (suggestionEl) suggestionEl.textContent = data.suggestion;
        
        const chartTemp = document.getElementById('chart-temp') as HTMLImageElement;
        const chartSolar = document.getElementById('chart-solar') as HTMLImageElement;
        
        if (chartTemp) chartTemp.src = `data:image/png;base64,${data.charts.temperature}`;
        if (chartSolar) chartSolar.src = `data:image/png;base64,${data.charts.solar}`;
        
        resultsEl?.classList.add('active');
        resultsEl?.classList.remove('hidden');
        resultsEl?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // ==========================================
    // EXPORT CSV
    // ==========================================
    
    btnExport?.addEventListener('click', async () => {
        const zona = zonaInput?.value;
        const lat = latInput?.value ? parseFloat(latInput.value) : null;
        const lon = lonInput?.value ? parseFloat(lonInput.value) : null;
        const tz = tzInput?.value || null;
        const daysInput = document.getElementById('days') as HTMLInputElement;
        const days = parseInt(daysInput?.value || '30');
        
        if (!zona) {
            showAlert('Please select or search for a location');
            return;
        }
        
        const exportBtn = btnExport as HTMLButtonElement;
        exportBtn.disabled = true;
        exportBtn.textContent = '‚è≥ Exporting...';
        
        try {
            const requestBody: Record<string, any> = { zona, days };
            if (lat !== null && lon !== null) {
                requestBody.lat = lat;
                requestBody.lon = lon;
                if (tz) requestBody.tz = tz;
            }
            
            const response = await fetch(`${API_URL}/api/export-csv`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error('Error exporting CSV');
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `energy_${zona}_${days}days_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAlert('‚úÖ CSV downloaded successfully', 'success');
            
        } catch (error: any) {
            console.error('Error:', error);
            showAlert(`‚ùå Error exporting: ${error.message}`);
        } finally {
            exportBtn.disabled = false;
            exportBtn.innerHTML = '<span>üì•</span> Export CSV Data';
        }
    });
    
    // ==========================================
    // CHECK CONNECTION ON LOAD
    // ==========================================
    
    window.addEventListener('load', async () => {
        try {
            const response = await fetch(`${API_URL}/api/health`);
            if (!response.ok) throw new Error('Backend not available');
            console.log('‚úÖ Connected to backend');
        } catch (error) {
            showAlert('‚ö†Ô∏è Cannot connect to backend. Make sure it is running on localhost:5000');
        }
    });
</script>
